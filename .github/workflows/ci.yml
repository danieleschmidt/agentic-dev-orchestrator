# Comprehensive CI Pipeline for Agentic Development Orchestrator
# Runs on pull requests and pushes to main branch

name: ğŸš€ Continuous Integration

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - '.dockerignore'
      - '.env.example'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - '.dockerignore'
      - '.env.example'
  workflow_dispatch:

# Ensure only one workflow runs at a time per branch
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Job 1: Code Quality Checks
  # ==========================================================================
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ¨ Check code formatting (Black)
      run: black --check --diff .

    - name: ğŸ“ Check import sorting (isort)
      run: isort --check-only --diff .

    - name: ğŸ”§ Lint code (Ruff)
      run: ruff check . --output-format=github

    - name: ğŸ·ï¸  Type checking (MyPy)
      run: mypy . --show-error-codes

    - name: ğŸ“ Check documentation format
      run: |
        markdownlint . --config .markdownlint.yml || true
        yamllint . --config-file .yamllint.yml

    - name: ğŸ”’ Security scan (Bandit)
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt || true

    - name: ğŸ›¡ï¸  Dependency security (Safety)
      run: |
        safety check --json --output safety-report.json || true
        pip-audit --output-format=json --output-file=pip-audit-report.json || true

    - name: ğŸ“Š Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
        retention-days: 30

  # ==========================================================================
  # Job 2: Testing Matrix
  # ==========================================================================
  test:
    name: ğŸ§ª Tests (Python ${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix size for efficiency
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.9'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ§ª Run unit tests
      run: |
        pytest tests/unit \
          --junitxml=junit/test-results-unit.xml \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=80

    - name: ğŸ”— Run integration tests
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        pytest tests/integration \
          --junitxml=junit/test-results-integration.xml \
          -m "not requires_network"

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          junit/
          htmlcov/
          coverage.xml
        retention-days: 30

    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ==========================================================================
  # Job 3: Performance Tests
  # ==========================================================================
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: âš¡ Run performance tests
      run: |
        pytest tests/performance \
          --benchmark-only \
          --benchmark-json=benchmark.json \
          --benchmark-sort=mean

    - name: ğŸ“Š Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: benchmark.json
        retention-days: 30

  # ==========================================================================
  # Job 4: Docker Build and Security Scan
  # ==========================================================================
  docker:
    name: ğŸ³ Docker Build & Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality]
    
    permissions:
      contents: read
      security-events: write
      packages: write

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸  Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ”¨ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tags }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # ==========================================================================
  # Job 5: Documentation Build
  # ==========================================================================
  docs:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install documentation dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ“– Build documentation
      run: |
        mkdocs build --strict
        
    - name: ğŸ“¤ Upload documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: site/
        retention-days: 30

    - name: ğŸš€ Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site

  # ==========================================================================
  # Job 6: End-to-End Tests
  # ==========================================================================
  e2e:
    name: ğŸ”„ End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, docker]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: ado_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸƒ Run E2E tests
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/ado_test
        REDIS_URL: redis://localhost:6379/0
        TESTING: true
      run: |
        pytest tests/e2e \
          --junitxml=junit/test-results-e2e.xml \
          -v

    - name: ğŸ“Š Upload E2E test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: junit/
        retention-days: 30

  # ==========================================================================
  # Job 7: Build Verification
  # ==========================================================================
  build:
    name: ğŸ“¦ Build Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality, test]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: ğŸ”¨ Build package
      run: python -m build

    - name: âœ… Verify package
      run: twine check dist/*

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: python-package
        path: dist/
        retention-days: 30

  # ==========================================================================
  # Job 8: Dependency Review
  # ==========================================================================
  dependency-review:
    name: ğŸ” Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        allow-dependencies-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  # ==========================================================================
  # Job 9: CodeQL Analysis
  # ==========================================================================
  codeql:
    name: ğŸ”’ CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [python]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        queries: +security-and-quality

    - name: ğŸ”¨ Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{ matrix.language }}"

  # ==========================================================================
  # Job 10: Status Check Summary
  # ==========================================================================
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: 
      - quality
      - test
      - performance
      - docker
      - docs
      - build
      - codeql
    if: always()

    steps:
    - name: âœ… Check all jobs status
      run: |
        if [[ "${{ needs.quality.result }}" != "success" || \
              "${{ needs.test.result }}" != "success" || \
              "${{ needs.performance.result }}" != "success" || \
              "${{ needs.docker.result }}" != "success" || \
              "${{ needs.docs.result }}" != "success" || \
              "${{ needs.build.result }}" != "success" || \
              "${{ needs.codeql.result }}" != "success" ]]; then
          echo "âŒ One or more CI jobs failed"
          exit 1
        else
          echo "âœ… All CI jobs passed successfully"
        fi

    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "ğŸ‰ CI pipeline completed successfully!"
        echo "âœ… Code quality checks passed"
        echo "âœ… All tests passed"
        echo "âœ… Security scans completed"
        echo "âœ… Documentation built"
        echo "âœ… Package built and verified"